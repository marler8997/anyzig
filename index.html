<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Install anyzig, a Zig package manager." />
    <link rel="stylesheet" href="styles.css" />
    <title>anyzig</title>
    <script>
      function get(id) {
        return document.getElementById(id);
      }

      function copyToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            showNotification("Command copied to clipboard!");
          })
          .catch((err) => {
            showNotification("Failed to copy command: " + err.message, true);
            console.error("Could not copy text: ", err);
          });
      }

      function copyCommand(id) {
        const pre = get("command" + id);
        if (pre) {
          copyToClipboard(pre.innerHTML);
        } else {
          showNotification("Command element not found", true);
        }
      }

      function generateCommandHtml(ids, cmd) {
        const id = ids.next_id;
        ids.next_id++;
        return (
          "<div>" +
          '<button class="CopyButton" onclick="copyCommand(' +
          id +
          ')">Copy</button> ' +
          '<code style="display:inline-block" id="command' +
          id +
          '">' +
          cmd +
          "</code>" +
          "</div>"
        );
      }

      function updateButton(button, enable) {
        if (!button) return;
        if (enable) {
          button.classList.add("FilterButtonEnabled");
        } else {
          button.classList.remove("FilterButtonEnabled");
        }
      }

      function toggleOs(os) {
        // Reset arch when changing OS to prevent invalid combinations
        if (current_os !== os) {
          current_arch = -1;
          updateButton(get("ButtonX86_64"), false);
          updateButton(get("ButtonAArch64"), false);
        }

        current_os = current_os === os ? -1 : os;

        updateButton(get("ButtonLinux"), current_os === OS_LINUX);
        updateButton(get("ButtonMacos"), current_os === OS_MACOS);
        updateButton(get("ButtonWindows"), current_os === OS_WINDOWS);
        updateInstallDiv();
      }

      function toggleArch(arch) {
        current_arch = current_arch === arch ? -1 : arch;
        updateButton(get("ButtonX86_64"), current_arch === ARCH_X86_64);
        updateButton(get("ButtonAArch64"), current_arch === ARCH_AARCH64);
        updateInstallDiv();
      }

      function getInstallCommand(archive_url, archive_ext) {
        if (archive_ext === ".zip") {
          return `Invoke-WebRequest -Uri "${archive_url}" -OutFile "anyzig.zip" && Expand-Archive -Path "anyzig.zip" -DestinationPath "anyzig"`;
        } else {
          return `curl -L "${archive_url}" | tar xz`;
        }
      }

      function updateInstallDiv() {
        let arch_os = null;
        let archive_ext = null;
        include_powershell = false;

        if (current_os === OS_LINUX) {
          archive_ext = ".tar.gz";
          if (current_arch === ARCH_X86_64) {
            arch_os = "x86_64-linux";
          } else if (current_arch === ARCH_AARCH64) {
            arch_os = "aarch64-linux";
          }
        } else if (current_os === OS_MACOS) {
          archive_ext = ".tar.gz";
          if (current_arch === ARCH_X86_64) {
            arch_os = "x86_64-macos";
          } else if (current_arch === ARCH_AARCH64) {
            arch_os = "aarch64-macos";
          }
        } else if (current_os === OS_WINDOWS) {
          archive_ext = ".zip";
          include_powershell = true;
          if (current_arch === ARCH_X86_64) {
            arch_os = "x86_64-windows";
          } else if (current_arch === ARCH_AARCH64) {
            arch_os = "aarch64-windows";
          }
        }

        let html = "";

        if (arch_os) {
          const basename = "anyzig-" + arch_os + archive_ext;
          const archive_url =
            "https://github.com/marler8997/anyzig/releases/latest/download/" +
            basename;
          html +=
            '<br/><h2 style="margin:15px"><a href="' +
            archive_url +
            '">' +
            basename +
            "</a></h2>";

          html += "<br/><h2>Command Line Install:</h2>";
          html += "<section><div class='Commands'>";
          const ids = { next_id: 0 };

          if (archive_ext === ".tar.gz") {
            if (include_curl) {
              html += generateCommandHtml(
                ids,
                "curl -L " + archive_url + " | tar xz"
              );
            }
            if (include_wget) {
              html += generateCommandHtml(
                ids,
                "wget -O - " + archive_url + " | tar xz"
              );
            }
          } else if (include_powershell) {
            html += generateCommandHtml(
              ids,
              getInstallCommand(archive_url, archive_ext)
            );
          }
          html += "</div></section>";
        } else if (current_os !== -1 && current_arch === -1) {
          html = "<br/><h2>Please select an architecture</h2>";
        } else if (current_os === -1) {
          html = "<br/><h2>Please select an operating system</h2>";
        }

        const installDiv = get("InstallDiv");
        if (installDiv) {
          installDiv.innerHTML = html;
        }
      }

      function bodyOnload() {
        updateInstallDiv();

        const userAgent = window.navigator.userAgent.toLowerCase();
        if (userAgent.includes("linux")) toggleOs(OS_LINUX);
        if (userAgent.includes("macintosh")) toggleOs(OS_MACOS);
        if (userAgent.includes("windows")) toggleOs(OS_WINDOWS);

        if (userAgent.includes("x64") || userAgent.includes("x86_64")) {
          toggleArch(ARCH_X86_64);
        } else if (
          userAgent.includes("aarch64") ||
          userAgent.includes("arm64")
        ) {
          toggleArch(ARCH_AARCH64);
        }
      }
    </script>
  </head>
  <body onload="bodyOnload()">
    <h1>Install anyzig</h1>
    <div style="margin: 10px">
      <span id="ButtonLinux" class="FilterButton" onclick="toggleOs(OS_LINUX)"
        >Linux</span
      >
      <span id="ButtonMacos" class="FilterButton" onclick="toggleOs(OS_MACOS)"
        >macOS</span
      >
      <span
        id="ButtonWindows"
        class="FilterButton"
        onclick="toggleOs(OS_WINDOWS)"
        >Windows</span
      >
    </div>
    <div style="margin: 10px">
      <span
        id="ButtonX86_64"
        class="FilterButton"
        onclick="toggleArch(ARCH_X86_64)"
        >x86_64</span
      >
      <span
        id="ButtonAArch64"
        class="FilterButton"
        onclick="toggleArch(ARCH_AARCH64)"
        >aarch64</span
      >
    </div>
    <div id="InstallDiv"></div>
  </body>
</html>
